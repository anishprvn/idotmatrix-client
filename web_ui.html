<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iDotMatrix Web Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .device-setup {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .controls {
            padding: 30px;
        }
        
        .control-section {
            margin-bottom: 40px;
        }
        
        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .color-picker {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî≤ iDotMatrix Web Controller</h1>
            <p>Control your 16x16 or 32x32 pixel displays with ease</p>
        </div>
        
        <div class="device-setup">
            <div class="form-group">
                <label for="deviceAddress">Device Address:</label>
                <input type="text" id="deviceAddress" placeholder="Enter MAC address or 'auto' for auto-discovery">
            </div>
            <div class="checkbox-item" style="margin-bottom: 15px;">
                <input type="checkbox" id="saveAddress" checked>
                <label for="saveAddress">Remember this address</label>
            </div>
            <button class="btn btn-primary" onclick="scanDevices()">üîç Scan for Devices</button>
            <button class="btn btn-success" onclick="connectDevice()">üîó Connect</button>
            <div id="deviceStatus" class="status disconnected">Not Connected</div>
        </div>
        
        <div class="controls">
            <!-- Basic Controls -->
            <div class="control-section">
                <h3>‚ö° Basic Controls</h3>
                <div class="button-grid">
                    <button class="btn btn-success" onclick="syncTime()">üïê Sync Time</button>
                    <button class="btn btn-success" onclick="screenOn()">üì∫ Screen On</button>
                    <button class="btn btn-warning" onclick="screenOff()">üì∫ Screen Off</button>
                    <button class="btn btn-info" onclick="resetDevice()">üîÑ Reset Device</button>
                </div>
            </div>
            
            <!-- Clock Controls -->
            <div class="control-section">
                <h3>üïê Clock Settings</h3>
                <div class="input-group">
                    <select id="clockStyle">
                        <option value="0">Default</option>
                        <option value="1">Christmas</option>
                        <option value="2">Racing</option>
                        <option value="3">Inverted Full Screen</option>
                        <option value="4">Animated Hourglass</option>
                        <option value="5">Frame 1</option>
                        <option value="6">Frame 2</option>
                        <option value="7">Frame 3</option>
                    </select>
                    <div class="color-picker-container">
                        <input type="color" id="clockColor" class="color-picker" value="#ffffff">
                        <label>Clock Color</label>
                    </div>
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showDate">
                        <label for="showDate">Show Date</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="format24h">
                        <label for="format24h">24H Format</label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="setClock()">‚è∞ Set Clock</button>
            </div>
            
            <!-- Text Controls -->
            <div class="control-section">
                <h3>üìù Text Display</h3>
                <div class="form-group">
                    <input type="text" id="textInput" placeholder="Enter text to display">
                </div>
                <div class="input-group">
                    <select id="textSize">
                        <option value="16">16px</option>
                        <option value="32">32px</option>
                    </select>
                    <select id="textMode">
                        <option value="0">Static</option>
                        <option value="1">Marquee Left</option>
                        <option value="2">Marquee Right</option>
                        <option value="3">Marquee Up</option>
                        <option value="4">Marquee Down</option>
                        <option value="5">Blinking</option>
                        <option value="6">Fading</option>
                        <option value="7">Tetris</option>
                        <option value="8">Filling</option>
                    </select>
                    <input type="range" id="textSpeed" min="0" max="100" value="95">
                </div>
                <div class="color-picker-container">
                    <input type="color" id="textColor" class="color-picker" value="#ff0000">
                    <label>Text Color</label>
                    <input type="color" id="textBgColor" class="color-picker" value="#000000">
                    <label>Background Color</label>
                </div>
                <button class="btn btn-primary" onclick="setText()">üìù Set Text</button>
            </div>
            
            <!-- Color Controls -->
            <div class="control-section">
                <h3>üé® Color Controls</h3>
                <div class="color-picker-container">
                    <input type="color" id="fullscreenColor" class="color-picker" value="#ffffff">
                    <label>Fullscreen Color</label>
                    <button class="btn btn-primary" onclick="setFullscreenColor()">üé® Apply</button>
                </div>
            </div>
            
            <!-- Timer Controls -->
            <div class="control-section">
                <h3>‚è±Ô∏è Timer Controls</h3>
                <div class="button-grid">
                    <button class="btn btn-success" onclick="startStopwatch()">‚ñ∂Ô∏è Start Stopwatch</button>
                    <button class="btn btn-warning" onclick="pauseStopwatch()">‚è∏Ô∏è Pause Stopwatch</button>
                    <button class="btn btn-info" onclick="resetStopwatch()">üîÑ Reset Stopwatch</button>
                </div>
                <div class="input-group">
                    <input type="number" id="countdownMinutes" placeholder="Minutes" min="0" max="99">
                    <input type="number" id="countdownSeconds" placeholder="Seconds" min="0" max="59">
                    <button class="btn btn-primary" onclick="startCountdown()">‚è∞ Start Countdown</button>
                </div>
            </div>
            
            <!-- Scoreboard -->
            <div class="control-section">
                <h3>üèÜ Scoreboard</h3>
                <div class="input-group">
                    <input type="number" id="score1" placeholder="Player 1 Score" min="0" max="999">
                    <input type="number" id="score2" placeholder="Player 2 Score" min="0" max="999">
                    <button class="btn btn-primary" onclick="setScoreboard()">üèÜ Update Score</button>
                </div>
            </div>
            
            <!-- File Upload -->
            <div class="control-section">
                <h3>üìÅ File Upload</h3>
                <div class="input-group">
                    <input type="file" id="imageFile" accept=".png,.jpg,.jpeg">
                    <select id="imageSize">
                        <option value="16">16x16</option>
                        <option value="32">32x32</option>
                    </select>
                    <button class="btn btn-primary" onclick="uploadImage()">üñºÔ∏è Upload Image</button>
                </div>
                <div class="input-group">
                    <input type="file" id="gifFile" accept=".gif">
                    <select id="gifSize">
                        <option value="16">16x16</option>
                        <option value="32">32x32</option>
                    </select>
                    <button class="btn btn-primary" onclick="uploadGif()">üé¨ Upload GIF</button>
                </div>
            </div>
        </div>
        
        <div class="console" id="console">
            <div>iDotMatrix Web Controller Console</div>
            <div>Ready to connect to device...</div>
        </div>
    </div>

    <script>
        let currentDevice = null;
        
        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        async function runCommand(args) {
            try {
                log(`Executing: ${args.join(' ')}`);
                
                // Since we can't directly execute shell commands from browser,
                // we'll use fetch to communicate with a simple Python server
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ args: args })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    log(`Success: ${result}`);
                } else {
                    log(`Error: ${response.statusText}`);
                }
            } catch (error) {
                log(`Error: ${error.message}`);
                // Fallback: show what command would be executed
                log(`Would execute: python3 app.py ${args.join(' ')}`);
            }
        }
        
        function getDeviceAddress() {
            const address = document.getElementById('deviceAddress').value.trim();
            if (!address) {
                alert('Please enter a device address');
                return null;
            }
            return address;
        }
        
        async function scanDevices() {
            log('Scanning for devices...');
            await runCommand(['--scan']);
        }
        
        async function connectDevice() {
            const address = getDeviceAddress();
            if (!address) return;
            
            // Save address if checkbox is checked
            if (document.getElementById('saveAddress').checked) {
                await saveAddress(address);
            }
            
            currentDevice = address;
            document.getElementById('deviceStatus').textContent = `Connected to ${address}`;
            document.getElementById('deviceStatus').className = 'status connected';
            log(`Connected to device: ${address}`);
        }
        
        async function saveAddress(address) {
            try {
                const response = await fetch('/save-address', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: address })
                });
                if (response.ok) {
                    log(`MAC address saved permanently: ${address}`);
                } else {
                    log('Failed to save MAC address');
                }
            } catch (error) {
                log(`Error saving address: ${error.message}`);
            }
        }
        
        async function loadAddress() {
            try {
                const response = await fetch('/load-address');
                if (response.ok) {
                    const data = await response.json();
                    if (data.address) {
                        document.getElementById('deviceAddress').value = data.address;
                        log(`Loaded saved MAC address: ${data.address}`);
                    }
                }
            } catch (error) {
                log(`Error loading address: ${error.message}`);
            }
        }
        
        async function syncTime() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--sync-time']);
        }
        
        async function screenOn() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--screen', 'on']);
        }
        
        async function screenOff() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--screen', 'off']);
        }
        
        async function resetDevice() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--reset']);
        }
        
        async function setClock() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const style = document.getElementById('clockStyle').value;
            const color = hexToRgb(document.getElementById('clockColor').value);
            const showDate = document.getElementById('showDate').checked;
            const format24h = document.getElementById('format24h').checked;
            
            let args = ['--address', address, '--clock', style, '--sync-time'];
            
            if (showDate) args.push('--clock-with-date');
            if (format24h) args.push('--clock-24h');
            if (color) args.push('--clock-color', `${color.r}-${color.g}-${color.b}`);
            
            await runCommand(args);
        }
        
        async function setText() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const text = document.getElementById('textInput').value;
            if (!text) {
                alert('Please enter text to display');
                return;
            }
            
            const size = document.getElementById('textSize').value;
            const mode = document.getElementById('textMode').value;
            const speed = document.getElementById('textSpeed').value;
            const textColor = hexToRgb(document.getElementById('textColor').value);
            const bgColor = hexToRgb(document.getElementById('textBgColor').value);
            
            let args = [
                '--address', address,
                '--set-text', text,
                '--text-size', size,
                '--text-mode', mode,
                '--text-speed', speed,
                '--text-color-mode', '1'
            ];
            
            if (textColor) args.push('--text-color', `${textColor.r}-${textColor.g}-${textColor.b}`);
            if (bgColor) {
                args.push('--text-bg-mode', '1');
                args.push('--text-bg-color', `${bgColor.r}-${bgColor.g}-${bgColor.b}`);
            }
            
            await runCommand(args);
        }
        
        async function setFullscreenColor() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const color = hexToRgb(document.getElementById('fullscreenColor').value);
            if (color) {
                await runCommand(['--address', address, '--fullscreen-color', `${color.r}-${color.g}-${color.b}`]);
            }
        }
        
        async function startStopwatch() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--chronograph', '1']);
        }
        
        async function pauseStopwatch() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--chronograph', '2']);
        }
        
        async function resetStopwatch() {
            const address = getDeviceAddress();
            if (!address) return;
            await runCommand(['--address', address, '--chronograph', '0']);
        }
        
        async function startCountdown() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const minutes = document.getElementById('countdownMinutes').value || '0';
            const seconds = document.getElementById('countdownSeconds').value || '0';
            
            if (minutes === '0' && seconds === '0') {
                alert('Please set a countdown time');
                return;
            }
            
            await runCommand(['--address', address, '--countdown', '1', '--countdown-time', `${minutes}-${seconds}`]);
        }
        
        async function setScoreboard() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const score1 = document.getElementById('score1').value || '0';
            const score2 = document.getElementById('score2').value || '0';
            
            await runCommand(['--address', address, '--scoreboard', `${score1}-${score2}`]);
        }
        
        async function uploadImage() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const fileInput = document.getElementById('imageFile');
            const size = document.getElementById('imageSize').value;
            
            if (!fileInput.files[0]) {
                alert('Please select an image file');
                return;
            }
            
            // In a real implementation, you'd upload the file to the server
            // For now, we'll just show what would happen
            log(`Would upload image: ${fileInput.files[0].name} with size ${size}x${size}`);
            log('Note: File upload requires server-side implementation');
        }
        
        async function uploadGif() {
            const address = getDeviceAddress();
            if (!address) return;
            
            const fileInput = document.getElementById('gifFile');
            const size = document.getElementById('gifSize').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a GIF file');
                return;
            }
            
            // In a real implementation, you'd upload the file to the server
            log(`Would upload GIF: ${fileInput.files[0].name} with size ${size}x${size}`);
            log('Note: File upload requires server-side implementation');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Load saved MAC address from server
            await loadAddress();
            
            log('Web Controller initialized');
            log('Enter device address and click Connect to start');
        });
    </script>
</body>
</html>